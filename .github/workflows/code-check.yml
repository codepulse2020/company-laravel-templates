name: Reusable Code Check

on:
  workflow_call:
    inputs:
      agents:
        description: "Which checks to run (comma separated)"
        required: false
        type: string
        default: "eslint,unit"
      role:
        description: "職能類型 (backend/frontend/qa/pm...)"
        required: false
        type: string
        default: "backend"
      ai_backend_rule_modules:
        description: "AI 規則模組，全部後端規則"
        required: false
        type: string
        default: "backend-*"
      ai_frontend_rule_modules:
        description: "AI 規則模組，全部前端規則"
        required: false
        type: string
        default: "frontend-*"
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.set-agents.outputs.agents }}
    steps:
      - id: set-agents
        run: |
          VALUE="${{ inputs.agents }}"
          VALUE=$(echo "$VALUE" | tr 'A-Z' 'a-z' | tr -d ' ')
          echo "agents=$VALUE" >> $GITHUB_OUTPUT

  eslint:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'eslint')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint

  unit:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'unit')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
      
  ai-review:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'ai')
    runs-on: ubuntu-latest

    env:
      ROLE: ${{ needs.prepare.outputs.role }}
      AI_RULE_MODULES: ${{ needs.prepare.outputs.ai_rule_modules }}

    steps:
      # 1. Checkout 專案本身，用來抓 diff
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get diff vs main
        id: diff
        run: |
          git fetch origin main
          DIFF=$(git diff origin/main...HEAD)
          echo "$DIFF" > diff.txt
          JSON_DIFF=$(printf '%s' "$DIFF" | jq -Rs .)
          echo "json_diff=$JSON_DIFF" >> $GITHUB_OUTPUT

      # 2. Checkout 共用 CI repo，讀 ai-rules/*.md
      - name: Checkout CI templates repo
        uses: actions/checkout@v4
        with:
          repository: your-org/company-ci-templates   # ← 改成你自己的 org/repo
          path: ci-templates

      # 3. 根據 ai_rule_modules 一個一個把 md 內容串起來
      - name: Build AI rules from modules
        id: rules
        run: |
          cd ci-templates
          
          RULE_TEXT=""
          
          IFS=',' read -ra MODULES <<< "$AI_RULE_MODULES"
          for MODULE in "${MODULES[@]}"; do
            FILE="ai-rules/${MODULE}.md"
            if [ -f "$FILE" ]; then
              echo "使用規則模組: $FILE"
              RULE_TEXT="${RULE_TEXT}\n\n===== MODULE: ${MODULE} =====\n\n$(cat "$FILE")"
            else
              echo "找不到規則模組檔案: $FILE，略過"
            fi
          done
          
          # 如果全部都沒找到，就使用 backend-default.md
          if [ -z "$RULE_TEXT" ] && [ -f "ai-rules/backend-default.md" ]; then
            echo "沒有任何模組載入，改用 backend-default.md"
            RULE_TEXT="$(cat ai-rules/backend-default.md)"
          fi
          
          echo -e "$RULE_TEXT" > merged-rules.txt
          JSON_RULES=$(printf '%s' "$RULE_TEXT" | jq -Rs .)
          echo "json_rules=$JSON_RULES" >> $GITHUB_OUTPUT

      # 4. 呼叫 OpenAI（或你之後自己的 AI）
      - name: Call OpenAI for AI review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BODY=$(cat <<EOF
          {
            "model": "gpt-5-mini",
            "messages": [
              {
                "role": "system",
                "content": "你是本公司的後端程式碼 reviewer，請嚴格依照後面提供的公司規範來審查程式碼，並用繁體中文回覆。"
              },
              {
                "role": "system",
                "content": ${{ steps.rules.outputs.json_rules }}
              },
              {
                "role": "user",
                "content": "以下是這次變更的 Git diff，請依照上述公司規範指出問題、風險與建議："
              },
              {
                "role": "user",
                "content": ${{ steps.diff.outputs.json_diff }}
              }
            ],
            "max_tokens": 1000
          }
          EOF
          )
          
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")
          
          echo "=== AI Review Result ==="
          echo "$RESPONSE" | jq -r '.choices[0].message.content'