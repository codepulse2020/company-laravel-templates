name: Reusable Code Check

on:
  workflow_call:
    inputs:
      agents:
        description: "Which checks to run (comma separated)"
        required: false
        type: string
        default: "eslint,unit"
      role:
        description: "職能類型 (backend/frontend/qa/pm...)"
        required: false
        type: string
        default: "backend"
      ai_backend_rule_modules:
        description: "AI 規則模組，全部後端規則"
        required: false
        type: string
        default: "backend-*"
      ai_frontend_rule_modules:
        description: "AI 規則模組，全部前端規則"
        required: false
        type: string
        default: "frontend-*"
      templates_repo:
        description: "CI templates repo slug (owner/repo)"
        required: false
        type: string
        default: "codepulse2020/company-laravel-templates"
      templates_ref:
        description: "Ref (branch/tag/sha) for templates repo to avoid default-branch lookup"
        required: false
        type: string
        default: "main"
      templates_auth:
        description: "Auth method to checkout templates repo (token|ssh)"
        required: false
        type: string
        default: "token"
      templates_token_secret_name:
        description: "Secret name that stores a PAT with read access to templates repo"
        required: false
        type: string
        default: "CI_TEMPLATES_READ_TOKEN"
      templates_ssh_key_secret_name:
        description: "Secret name that stores a read-only deploy SSH key for templates repo"
        required: false
        type: string
        default: "CI_TEMPLATES_SSH_KEY"
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.set-agents.outputs.agents }}
      role: ${{ steps.set-params.outputs.role }}
      ai_rule_modules: ${{ steps.set-params.outputs.ai_rule_modules }}
    steps:
      - id: set-agents
        run: |
          VALUE="${{ inputs.agents }}"
          VALUE=$(echo "$VALUE" | tr 'A-Z' 'a-z' | tr -d ' ')
          echo "agents=$VALUE" >> $GITHUB_OUTPUT

      - id: set-params
        run: |
          ROLE="${{ inputs.role }}"
          # 根據 role 選擇要使用的規則模組清單
          if [ "$ROLE" = "frontend" ]; then
            AI_RULE_MODULES="${{ inputs.ai_frontend_rule_modules }}"
          else
            AI_RULE_MODULES="${{ inputs.ai_backend_rule_modules }}"
          fi
          echo "role=$ROLE" >> $GITHUB_OUTPUT
          echo "ai_rule_modules=$AI_RULE_MODULES" >> $GITHUB_OUTPUT

  eslint:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'eslint')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint

  unit:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'unit')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
      
  ai-review:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'ai')
    runs-on: ubuntu-latest

    env:
      ROLE: ${{ needs.prepare.outputs.role }}
      AI_RULE_MODULES: ${{ needs.prepare.outputs.ai_rule_modules }}

    steps:
      # 1. Checkout 專案本身，用來抓 diff
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get diff vs default branch (robust)
        id: diff
        run: |
          set -e
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"

          # 確保有足夠歷史可找 merge-base
          git fetch --depth=0 origin "$DEFAULT_BRANCH" || true

          # 嘗試使用三點差異（需要 merge-base）
          if git merge-base HEAD origin/"$DEFAULT_BRANCH" >/dev/null 2>&1 ; then
            DIFF=$(git diff origin/"$DEFAULT_BRANCH"...HEAD)
          else
            echo "No merge-base. Falling back to two-dot diff"
            DIFF=$(git diff origin/"$DEFAULT_BRANCH"..HEAD || true)
            if [ -z "$DIFF" ]; then
              echo "Fallback to last-commit diff"
              DIFF=$(git diff HEAD^..HEAD || true)
            fi
          fi
          echo "$DIFF" > diff.txt
          JSON_DIFF=$(printf '%s' "$DIFF" | jq -Rs .)
          echo "json_diff=$JSON_DIFF" >> $GITHUB_OUTPUT

      # Decide whether we need to checkout the external templates repo for ai-rules
      - name: Decide rules source
        id: decide
        run: |
          USE_TEMPLATES="false"
          if [ "${{ github.repository }}" = "${{ inputs.templates_repo }}" ]; then
            echo "Running inside templates repo; will use local ai-rules" >&2
          elif [ -d "ai-rules" ]; then
            echo "Local ai-rules found in target repo; skip external checkout" >&2
          else
            USE_TEMPLATES="true"
            echo "No local ai-rules found; will checkout templates repo" >&2
          fi
          echo "use_templates=$USE_TEMPLATES" >> $GITHUB_OUTPUT

      # If we need templates, ensure the selected auth has a secret configured
      - name: Validate templates checkout credentials
        if: ${{ steps.decide.outputs.use_templates == 'true' }}
        run: |
          AUTH="${{ inputs.templates_auth }}"
          if [ "$AUTH" = "token" ]; then
            if [ -z "${{ secrets[inputs.templates_token_secret_name] }}" ]; then
              echo "Missing secret '${{ inputs.templates_token_secret_name }}' required for token auth to checkout '${{ inputs.templates_repo }}'." >&2
              echo "Please add a PAT with read access as this secret in the caller repository, or set 'templates_auth: ssh' and provide '${{ inputs.templates_ssh_key_secret_name }}'." >&2
              exit 1
            fi
          elif [ "$AUTH" = "ssh" ]; then
            if [ -z "${{ secrets[inputs.templates_ssh_key_secret_name] }}" ]; then
              echo "Missing secret '${{ inputs.templates_ssh_key_secret_name }}' required for SSH auth to checkout '${{ inputs.templates_repo }}'." >&2
              echo "Please add a read-only deploy key as this secret in the caller repository, or set 'templates_auth: token' and provide '${{ inputs.templates_token_secret_name }}'." >&2
              exit 1
            fi
          else
            echo "Invalid templates_auth value: '${{ inputs.templates_auth }}'. Expected 'token' or 'ssh'." >&2
            exit 1
          fi

      # 2. Checkout 共用 CI repo，讀 ai-rules/*.md
      - name: Checkout CI templates repo (token)
        if: ${{ steps.decide.outputs.use_templates == 'true' && inputs.templates_auth == 'token' && secrets[inputs.templates_token_secret_name] != '' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.templates_repo }}
          ref: ${{ inputs.templates_ref }}
          token: ${{ secrets[inputs.templates_token_secret_name] }}
          path: laravel-templates

      - name: Checkout CI templates repo (ssh)
        if: ${{ steps.decide.outputs.use_templates == 'true' && inputs.templates_auth == 'ssh' && secrets[inputs.templates_ssh_key_secret_name] != '' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.templates_repo }}
          ref: ${{ inputs.templates_ref }}
          ssh-key: ${{ secrets[inputs.templates_ssh_key_secret_name] }}
          path: laravel-templates

      # 3. 根據 ai_rule_modules 一個一個把 md 內容串起來
      - name: Build AI rules from modules
        id: rules
        run: |
          if [ -d "laravel-templates/ai-rules" ]; then
            cd laravel-templates
          elif [ -d "ai-rules" ]; then
            echo "Using local ai-rules in current repo"
          else
            echo "ai-rules directory not found in either laravel-templates or current repo" >&2
            exit 1
          fi
          
          RULE_TEXT=""
          
          IFS=',' read -ra MODULE_PATTERNS <<< "$AI_RULE_MODULES"
          for PATTERN in "${MODULE_PATTERNS[@]}"; do
            # 展開通配符合的檔案清單
            MATCHED=0
            for FILE in ai-rules/${PATTERN}.md; do
              if [ -f "$FILE" ]; then
                MODULE_NAME=$(basename "$FILE" .md)
                echo "使用規則模組: $FILE"
                RULE_TEXT="${RULE_TEXT}\n\n===== MODULE: ${MODULE_NAME} =====\n\n$(cat "$FILE")"
                MATCHED=1
              fi
            done
            if [ "$MATCHED" -eq 0 ]; then
              echo "找不到規則模組檔案: ai-rules/${PATTERN}.md，略過"
            fi
          done
          
          # 如果全部都沒找到，就使用存在的預設檔案（改用 backend-main.md）
          if [ -z "$RULE_TEXT" ] && [ -f "ai-rules/backend-main.md" ]; then
            echo "沒有任何模組載入，改用 backend-main.md"
            RULE_TEXT="$(cat ai-rules/backend-main.md)"
          fi
          
          echo -e "$RULE_TEXT" > merged-rules.txt
          JSON_RULES=$(printf '%s' "$RULE_TEXT" | jq -Rs .)
          echo "json_rules=$JSON_RULES" >> $GITHUB_OUTPUT

      # 4. 呼叫 OpenAI（或你之後自己的 AI）
      - name: Call OpenAI for AI review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BODY=$(cat <<EOF
          {
            "model": "gpt-5-mini",
            "messages": [
              {
                "role": "system",
                "content": "你是本公司的後端程式碼 reviewer，請嚴格依照後面提供的公司規範來審查程式碼，並用繁體中文回覆。"
              },
              {
                "role": "system",
                "content": ${{ steps.rules.outputs.json_rules }}
              },
              {
                "role": "user",
                "content": "以下是這次變更的 Git diff，請依照上述公司規範指出問題、風險與建議："
              },
              {
                "role": "user",
                "content": ${{ steps.diff.outputs.json_diff }}
              }
            ],
            "max_tokens": 1000
          }
          EOF
          )
          
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")
          
          echo "=== AI Review Result ==="
          echo "$RESPONSE" | jq -r '.choices[0].message.content'