name: Reusable Code Check

on:
  workflow_call:
    inputs:
      agents:
        description: "Which checks to run (comma separated)"
        required: false
        type: string
        default: "eslint,unit"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.set-agents.outputs.agents }}
    steps:
      - id: set-agents
        run: |
          VALUE="${{ inputs.agents }}"
          VALUE=$(echo "$VALUE" | tr 'A-Z' 'a-z' | tr -d ' ')
          echo "agents=$VALUE" >> $GITHUB_OUTPUT

  eslint:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'eslint')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint

  unit:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'unit')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
      
  ai-review:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'ai')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ­·å²è¨˜éŒ„ä»¥ä¾¿æ¯”è¼ƒ
    
      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq
    
      - name: Get diff vs main
        id: diff
        run: |
          git fetch origin main
          # å–å¾—é€™æ¬¡ PR / commit ç›¸å° main çš„ diff
          DIFF=$(git diff origin/main...HEAD)
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if [ -z "$DIFF" ]; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å­˜æˆæª”æ¡ˆæ–¹ä¾¿ debug
          echo "$DIFF" > diff.txt
          
          # é™åˆ¶ diff å¤§å°ï¼ˆé¿å…è¶…é API é™åˆ¶ï¼‰
          DIFF_SIZE=$(echo "$DIFF" | wc -c)
          if [ "$DIFF_SIZE" -gt 10000 ]; then
            DIFF=$(echo "$DIFF" | head -c 10000)
            echo "Warning: Diff truncated to 10000 characters"
          fi
          
          # ç”¨ base64 ç·¨ç¢¼é¿å…ç‰¹æ®Šå­—å…ƒå•é¡Œ
          ENCODED_DIFF=$(echo "$DIFF" | base64 -w 0)
          echo "encoded_diff=$ENCODED_DIFF" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
    
      - name: Call OpenAI for code review
        if: steps.diff.outputs.has_changes == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # è§£ç¢¼ diff
          DIFF=$(echo "${{ steps.diff.outputs.encoded_diff }}" | base64 -d)
          
          # è½‰ç¾©ç‚º JSON å­—ä¸²
          DIFF_JSON=$(echo "$DIFF" | jq -Rs .)
          
          # çµ„ Chat Completions è«‹æ±‚
          cat > request.json <<EOF
          {
            "model": "gpt-4o-mini",
            "messages": [
              {
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä½åš´æ ¼çš„ç¨‹å¼ç¢¼ reviewerï¼Œå°ˆé–€å¹«å¿™æ‰¾å‡º bugã€è³‡å®‰é¢¨éšªèˆ‡ä¸ä½³çš„å¯«æ³•ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚è«‹ç‰¹åˆ¥æ³¨æ„ï¼š\n1. SQL æ³¨å…¥é¢¨éšª\n2. XSS æ”»æ“Šé¢¨éšª\n3. æœªé©—è­‰çš„ä½¿ç”¨è€…è¼¸å…¥\n4. æ•æ„Ÿè³‡è¨Šå¤–æ´©\n5. æ•ˆèƒ½å•é¡Œ\n6. ç¨‹å¼ç¢¼é‡è¤‡\n7. é•åæœ€ä½³å¯¦è¸"
              },
              {
                "role": "user",
                "content": "è«‹é‡å°ä»¥ä¸‹ Git diffï¼ŒæŒ‡å‡ºä½ çœ‹åˆ°çš„å•é¡Œã€é¢¨éšªèˆ‡å»ºè­°ï¼ˆå¦‚æœæ²’å•é¡Œå¯ä»¥èªªæ˜ç‚ºä»€éº¼è¦ºå¾—æ²’å•é¡Œï¼‰ï¼š\n\nDIFF:\n${DIFF_JSON}"
              }
            ],
            "max_tokens": 1500,
            "temperature": 0.3
          }
          EOF
          
          # å‘¼å« OpenAI API
          RESPONSE=$(curl -s -w "\n%{http_code}" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json)
          
          # åˆ†é›¢ HTTP ç‹€æ…‹ç¢¼å’Œå›æ‡‰å…§å®¹
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "=== HTTP Status Code ==="
          echo "$HTTP_CODE"
          
          echo "=== OpenAI raw response ==="
          echo "$RESPONSE_BODY"
          
          # æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: OpenAI API returned status code $HTTP_CODE"
            echo "$RESPONSE_BODY" | jq -r '.error.message // "Unknown error"'
            exit 1
          fi
          
          # æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
          if echo "$RESPONSE_BODY" | jq -e '.error' > /dev/null; then
            echo "Error from OpenAI:"
            echo "$RESPONSE_BODY" | jq -r '.error.message'
            exit 1
          fi
          
          # æŠŠ AI çš„æ–‡å­—å…§å®¹æ‹‰å‡ºä¾†
          echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content' > ai_review.txt
          
          echo "=== AI Review Result ==="
          cat ai_review.txt
          
          # å°‡çµæœå­˜æˆ artifactï¼ˆå¯åœ¨ GitHub Actions ä»‹é¢ä¸‹è¼‰ï¼‰
          echo "AI review completed successfully"
      
      - name: Upload AI Review Result
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-result
          path: |
            ai_review.txt
            diff.txt
          retention-days: 30
      
      - name: Comment on PR (Optional)
        if: steps.diff.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('ai_review.txt', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– AI Code Review\n\n${review}`
            });
