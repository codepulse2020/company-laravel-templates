name: Reusable Code Check

on:
  workflow_call:
    secrets:
      CI_TEMPLATES_READ_TOKEN:
        description: PAT with read access to the templates repo (used when templates_auth=token)
        required: false
      CI_TEMPLATES_SSH_KEY:
        description: Read-only deploy SSH private key for the templates repo (used when templates_auth=ssh)
        required: false
      OPENAI_API_KEY:
        description: API key for OpenAI used by the ai-review job
        required: false
    inputs:
      agents:
        description: "Which checks to run (comma separated)"
        required: false
        type: string
        default: "eslint,unit"
      role:
        description: "職能類型 (backend/frontend/qa/pm...)"
        required: false
        type: string
        default: "backend"
      ai_backend_rule_modules:
        description: "AI 規則模組，全部後端規則"
        required: false
        type: string
        default: "backend-*"
      ai_frontend_rule_modules:
        description: "AI 規則模組，全部前端規則"
        required: false
        type: string
        default: "frontend-*"
      templates_repo:
        description: "CI templates repo slug (owner/repo)"
        required: false
        type: string
        default: "codepulse2020/company-laravel-templates"
      templates_ref:
        description: "Ref (branch/tag/sha) for templates repo to avoid default-branch lookup"
        required: false
        type: string
        default: "main"
      templates_auth:
        description: "Auth method to checkout templates repo (token|ssh)"
        required: false
        type: string
        default: "token"
      ai_fail_on_violation:
        description: "If true, fail the job when violations are found"
        required: false
        type: string
        default: "false"
      ai_fail_min_severity:
        description: "Minimum severity to fail on (minor|major|critical)"
        required: false
        type: string
        default: "major"
      ai_max_diff_chars:
        description: "Max diff chars to send to AI (large diffs will be truncated)"
        required: false
        type: string
        default: "50000"
      ai_validate_key:
        description: "在執行 AI 稽核前先做健康檢查（確認 OPENAI_API_KEY 與連線可用）"
        required: false
        type: string
        default: "true"
      ai_validation_strict:
        description: "健康檢查失敗時是否直接失敗（true=失敗, false=僅警告）"
        required: false
        type: string
        default: "false"
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.set-agents.outputs.agents }}
      role: ${{ steps.set-params.outputs.role }}
      ai_rule_modules: ${{ steps.set-params.outputs.ai_rule_modules }}
    steps:
      - id: set-agents
        run: |
          VALUE="${{ inputs.agents }}"
          VALUE=$(echo "$VALUE" | tr 'A-Z' 'a-z' | tr -d ' ')
          echo "agents=$VALUE" >> $GITHUB_OUTPUT

      - id: set-params
        run: |
          ROLE="${{ inputs.role }}"
          # 根據 role 選擇要使用的規則模組清單
          if [ "$ROLE" = "frontend" ]; then
            AI_RULE_MODULES="${{ inputs.ai_frontend_rule_modules }}"
          else
            AI_RULE_MODULES="${{ inputs.ai_backend_rule_modules }}"
          fi
          echo "role=$ROLE" >> $GITHUB_OUTPUT
          echo "ai_rule_modules=$AI_RULE_MODULES" >> $GITHUB_OUTPUT

  eslint:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'eslint')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint

  unit:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'unit')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
      
  ai-review:
    needs: prepare
    if: contains(needs.prepare.outputs.agents, 'ai')
    runs-on: ubuntu-latest

    env:
      ROLE: ${{ needs.prepare.outputs.role }}
      AI_RULE_MODULES: ${{ needs.prepare.outputs.ai_rule_modules }}

    steps:
      # 1. Checkout 專案本身，用來抓 diff
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate OpenAI API key and connectivity
        if: ${{ inputs.ai_validate_key == 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          STRICT="${{ inputs.ai_validation_strict }}"
          {
            echo "### AI Health Check"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -z "$OPENAI_API_KEY" ]; then
            {
              echo "- Result: FAIL (OPENAI_API_KEY is missing)"
              echo "> 請在呼叫端 Repo/Org/User 的 Actions Secrets 設定 OPENAI_API_KEY，或將 agents 移除 ai。"
            } >> "$GITHUB_STEP_SUMMARY"
            if [ "$STRICT" = "true" ]; then
              echo "[ai-health] Missing OPENAI_API_KEY" >&2
              exit 1
            else
              exit 0
            fi
          fi

          # 送一個最小請求做健康檢查
          BODY=$(cat <<'EOF'
          {"model":"gpt-5-mini","temperature":0,"max_tokens":1,
           "messages":[{"role":"user","content":"ping"}]}
          EOF
          )

          CODE_FILE=$(mktemp)
          RESP_FILE=$(mktemp)
          curl -s -w "%{http_code}" -o "$RESP_FILE" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" > "$CODE_FILE"
          STATUS=$(cat "$CODE_FILE")
          RAW=$(cat "$RESP_FILE")
          CONTENT=$(echo "$RAW" | jq -r '.choices[0].message.content // empty' 2>/dev/null || true)

          if [ -n "$CONTENT" ] && [ "$STATUS" -lt 400 ]; then
            {
              echo "- HTTP status: ${STATUS}"
              echo "- Result: OK"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            SNIPPET=$(echo "$RAW" | head -c 500)
            {
              echo "- HTTP status: ${STATUS}"
              echo "- Result: FAIL"
              echo "<details><summary>Raw response (first 500 chars)</summary>"
              echo
              echo '```json'
              echo "$SNIPPET"
              echo
              echo '```'
              echo "</details>"
              echo "> 若為 401/403，請確認 API Key 與權限；429 請稍後重試；404/400 請確認模型名稱是否可用。"
            } >> "$GITHUB_STEP_SUMMARY"
            if [ "$STRICT" = "true" ]; then
              exit 1
            fi
          fi

      - name: Get diff vs base (PR/push-aware, robust)
        id: diff
        run: |
          set -e
          EVENT_NAME="${{ github.event_name }}"

          DIFF=""
          BASE_DESC=""
          HEAD_DESC=""

          # Prefer PR base/head when available
          if [ "$EVENT_NAME" = "pull_request" ] || [ "$EVENT_NAME" = "pull_request_target" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            BASE_DESC="$BASE_SHA (PR base)"
            HEAD_DESC="$HEAD_SHA (PR head)"
            git fetch --depth=0 origin "$BASE_SHA" || true
            git fetch --depth=0 origin "$HEAD_SHA" || true
            # Use three-dot to compare against merge-base
            if git merge-base "$HEAD_SHA" "$BASE_SHA" >/dev/null 2>&1 ; then
              DIFF=$(git diff "$BASE_SHA"..."$HEAD_SHA")
            else
              echo "[ai-review] PR SHAs have no merge-base. Falling back to two-dot." >&2
              DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" || true)
            fi
          else
            # Push or other events: use before/after SHAs if available
            BEFORE_SHA="${{ github.event.before }}"
            AFTER_SHA="${{ github.sha }}"
            if [ -n "$BEFORE_SHA" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
              BASE_DESC="$BEFORE_SHA (push before)"
              HEAD_DESC="$AFTER_SHA (current)"
              git fetch --depth=0 origin "$BEFORE_SHA" || true
              git fetch --depth=0 origin "$AFTER_SHA" || true
              DIFF=$(git diff "$BEFORE_SHA".."$AFTER_SHA" || true)
            fi

            # If still empty, fallback to default branch logic
            if [ -z "$DIFF" ]; then
              DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
              if [ -z "$DEFAULT_BRANCH" ]; then
                git remote set-head origin -a >/dev/null 2>&1 || true
                DEFAULT_BRANCH=$(git symbolic-ref --short refs/remotes/origin/HEAD 2>/dev/null | sed 's#^origin/##' || true)
              fi
              if [ -z "$DEFAULT_BRANCH" ]; then
                DEFAULT_BRANCH="main"
              fi
              BASE_DESC="origin/${DEFAULT_BRANCH} (default branch)"
              HEAD_DESC="HEAD"
              git fetch --depth=0 origin "$DEFAULT_BRANCH" || true
              if git merge-base HEAD origin/"$DEFAULT_BRANCH" >/dev/null 2>&1 ; then
                DIFF=$(git diff origin/"$DEFAULT_BRANCH"...HEAD)
              else
                echo "[ai-review] No merge-base with default branch. Falling back to two-dot." >&2
                DIFF=$(git diff origin/"$DEFAULT_BRANCH"..HEAD || true)
                if [ -z "$DIFF" ]; then
                  echo "[ai-review] Final fallback to last commit diff." >&2
                  DIFF=$(git diff HEAD^..HEAD || true)
                fi
              fi
            fi
          fi

          echo "$DIFF" > diff.txt
          JSON_DIFF=$(printf '%s' "$DIFF" | jq -Rs .)
          echo "json_diff=$JSON_DIFF" >> $GITHUB_OUTPUT

          # Outputs for later steps
          DIFF_BYTES=$(wc -c < diff.txt | tr -d ' ')
          if [ "$DIFF_BYTES" -eq 0 ]; then
            echo "diff_empty=true" >> $GITHUB_OUTPUT
          else
            echo "diff_empty=false" >> $GITHUB_OUTPUT
          fi
          echo "base_ref=$BASE_DESC" >> $GITHUB_OUTPUT
          echo "head_ref=$HEAD_DESC" >> $GITHUB_OUTPUT

      - name: Summarize diff
        if: always()
        run: |
          if [ -f diff.txt ]; then
            DIFF_LEN=$(wc -c < diff.txt | tr -d ' ')
            echo "[ai-review] Diff bytes: $DIFF_LEN"
            {
              echo "### AI Review · Diff"
              echo "- Diff size: ${DIFF_LEN} bytes"
              echo "- Base: ${{ steps.diff.outputs.base_ref }}"
              echo "- Head: ${{ steps.diff.outputs.head_ref }}"
              echo "<details><summary>Preview (first 200 chars)</summary>"
              echo
              echo '```diff'
              head -c 200 diff.txt || true
              echo
              echo '```'
              echo "</details>"
              if [ "${{ steps.diff.outputs.diff_empty }}" = "true" ]; then
                echo
                echo "> Diff 為空：這通常表示這次提交相對於基準分支沒有變更，或事件基準偵測失敗。若你確定有變更，請確認 PR base/head 或 push 的 before/after 是否正確。"
              fi
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "[ai-review] diff.txt not found; skip summary"
          fi

      # Decide whether we need to checkout the external templates repo for ai-rules
      - name: Decide rules source
        id: decide
        run: |
          USE_TEMPLATES="false"
          if [ "${{ github.repository }}" = "${{ inputs.templates_repo }}" ]; then
            echo "Running inside templates repo; will use local ai-rules" >&2
          elif [ -d "ai-rules" ]; then
            echo "Local ai-rules found in target repo; skip external checkout" >&2
          else
            USE_TEMPLATES="true"
            echo "No local ai-rules found; will checkout templates repo" >&2
          fi
          echo "use_templates=$USE_TEMPLATES" >> $GITHUB_OUTPUT

      # If we need templates, ensure the selected auth has a secret configured
      - name: Validate templates checkout credentials (with public fallback)
        id: creds
        if: ${{ steps.decide.outputs.use_templates == 'true' }}
        run: |
          AUTH="${{ inputs.templates_auth }}"
          USE_PUBLIC_FALLBACK="false"
          case "$AUTH" in
            token)
              if [ -z "${{ secrets.CI_TEMPLATES_READ_TOKEN }}" ]; then
                echo "CI_TEMPLATES_READ_TOKEN is missing; will try public fallback clone." >&2
                USE_PUBLIC_FALLBACK="true"
              fi
              ;;
            ssh)
              if [ -z "${{ secrets.CI_TEMPLATES_SSH_KEY }}" ]; then
                echo "CI_TEMPLATES_SSH_KEY is missing; will try public fallback clone." >&2
                USE_PUBLIC_FALLBACK="true"
              fi
              ;;
            public)
              echo "templates_auth=public; will use unauthenticated public clone." >&2
              USE_PUBLIC_FALLBACK="true"
              ;;
            *)
              echo "Invalid templates_auth value: '${{ inputs.templates_auth }}'. Expected 'token', 'ssh', or 'public'." >&2
              exit 1
              ;;
          esac
          echo "use_public_fallback=$USE_PUBLIC_FALLBACK" >> $GITHUB_OUTPUT

      # 2. Checkout 共用 CI repo，讀 ai-rules/*.md
      - name: Checkout CI templates repo (token)
        if: ${{ steps.decide.outputs.use_templates == 'true' && inputs.templates_auth == 'token' && steps.creds.outputs.use_public_fallback != 'true' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.templates_repo }}
          ref: ${{ inputs.templates_ref }}
          token: ${{ secrets.CI_TEMPLATES_READ_TOKEN }}
          path: laravel-templates

      - name: Checkout CI templates repo (ssh)
        if: ${{ steps.decide.outputs.use_templates == 'true' && inputs.templates_auth == 'ssh' && steps.creds.outputs.use_public_fallback != 'true' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.templates_repo }}
          ref: ${{ inputs.templates_ref }}
          ssh-key: ${{ secrets.CI_TEMPLATES_SSH_KEY }}
          path: laravel-templates

      - name: Public fallback checkout (no credentials)
        if: ${{ steps.decide.outputs.use_templates == 'true' && steps.creds.outputs.use_public_fallback == 'true' }}
        run: |
          set -e
          REPO="${{ inputs.templates_repo }}"
          REF="${{ inputs.templates_ref }}"
          echo "Attempt unauthenticated public clone for $REPO@$REF" >&2
          if [ -d "laravel-templates/ai-rules" ]; then
            echo "laravel-templates/ai-rules already present, skip clone"
            exit 0
          fi
          if command -v git >/dev/null 2>&1; then
            git clone --depth=1 --branch "$REF" "https://github.com/${REPO}.git" laravel-templates || true
          fi
          if [ ! -d "laravel-templates/ai-rules" ]; then
            echo "git clone failed or ai-rules not found, try tarball download" >&2
            mkdir -p _dl && cd _dl
            curl -sSL "https://codeload.github.com/${REPO}/tar.gz/${REF}" -o repo.tgz
            tar xzf repo.tgz
            TOPDIR=$(tar tzf repo.tgz | head -1 | cut -f1 -d"/")
            cd ..
            rm -rf laravel-templates
            mv "_dl/${TOPDIR}" laravel-templates || true
          fi
          if [ ! -d "laravel-templates/ai-rules" ]; then
            echo "Public fallback failed: ai-rules not found in ${REPO}@${REF}" >&2
            exit 1
          fi

      # 3.5 依 diff 產生提示（heuristics hints）協助 AI 聚焦常見問題
      - name: Generate AI hints from diff
        id: hints
        run: |
          set -e
          : > hints.txt
          if [ ! -s diff.txt ]; then
            echo "[ai-review] No diff content for hints." >&2
          else
            echo "# Heuristic hints from diff patterns" >> hints.txt
            echo "" >> hints.txt
            # 常見 Laravel/後端風險模式
            echo "## Potential risky patterns" >> hints.txt
            echo "" >> hints.txt
            grep -nE "\\$request->all\\(|Illuminate\\\\Http\\\\Request|abort\\(|DB::(select|statement|raw)\\(|\\bselect \\* from\\b|->json\\(|Resource::(make|collection)\\(|meta\\.pagination|password|token" diff.txt || true >> hints.txt
            echo "" >> hints.txt
            echo "## Notes" >> hints.txt
            echo "- 注意使用 FormRequest 驗證（避免 Illuminate\\\\Http\\\\Request 與 $request->all()）。" >> hints.txt
            echo "- 應使用 Resource/Presenter 統一輸出格式，包含 meta.pagination。" >> hints.txt
            echo "- 例外處理與錯誤碼應符合 ExceptionCode 規範，不直接 abort()。" >> hints.txt
          fi
          HINTS_JSON=$(jq -Rs . < hints.txt)
          echo "json_hints=$HINTS_JSON" >> $GITHUB_OUTPUT
          HINTS_BYTES=$(wc -c < hints.txt | tr -d ' ')
          echo "hints_bytes=$HINTS_BYTES" >> $GITHUB_OUTPUT

      - name: Summarize hints
        if: always()
        run: |
          if [ -f hints.txt ]; then
            HINTS_LEN=$(wc -c < hints.txt | tr -d ' ')
            {
              echo "### AI Review · Hints"
              echo "- Hints size: ${HINTS_LEN} bytes"
              echo "<details><summary>Preview (first 200 chars)</summary>"
              echo
              echo '```text'
              head -c 200 hints.txt || true
              echo
              echo '```'
              echo "</details>"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      # 3. 根據 ai_rule_modules 一個一個把 md 內容串起來
      - name: Build AI rules from modules
        id: rules
        run: |
          if [ -d "laravel-templates/ai-rules" ]; then
            cd laravel-templates
          elif [ -d "ai-rules" ]; then
            echo "Using local ai-rules in current repo"
          else
            echo "ai-rules directory not found in either laravel-templates or current repo" >&2
            exit 1
          fi
          
          RULE_TEXT=""
          
          IFS=',' read -ra MODULE_PATTERNS <<< "$AI_RULE_MODULES"
          for PATTERN in "${MODULE_PATTERNS[@]}"; do
            # 展開通配符合的檔案清單
            MATCHED=0
            for FILE in ai-rules/${PATTERN}.md; do
              if [ -f "$FILE" ]; then
                MODULE_NAME=$(basename "$FILE" .md)
                echo "使用規則模組: $FILE"
                RULE_TEXT="${RULE_TEXT}\n\n===== MODULE: ${MODULE_NAME} =====\n\n$(cat "$FILE")"
                MATCHED=1
              fi
            done
            if [ "$MATCHED" -eq 0 ]; then
              echo "找不到規則模組檔案: ai-rules/${PATTERN}.md，略過"
            fi
          done
          
          # 如果全部都沒找到，就使用存在的預設檔案（改用 backend-main.md）
          if [ -z "$RULE_TEXT" ] && [ -f "ai-rules/backend-main.md" ]; then
            echo "沒有任何模組載入，改用 backend-main.md"
            RULE_TEXT="$(cat ai-rules/backend-main.md)"
          fi
          
          echo -e "$RULE_TEXT" > merged-rules.txt
          JSON_RULES=$(printf '%s' "$RULE_TEXT" | jq -Rs .)
          echo "json_rules=$JSON_RULES" >> $GITHUB_OUTPUT

      - name: Summarize rules
        if: always()
        run: |
          if [ -f merged-rules.txt ]; then
            RULES_LEN=$(wc -c < merged-rules.txt | tr -d ' ')
            echo "[ai-review] Rules bytes: $RULES_LEN"
            {
              echo "### AI Review · Rules"
              echo "- Rules size: ${RULES_LEN} bytes"
              echo "<details><summary>Preview (first 200 chars)</summary>"
              echo
              echo '```markdown'
              head -c 200 merged-rules.txt || true
              echo
              echo '```'
              echo "</details>"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "[ai-review] merged-rules.txt not found; skip summary"
          fi

      - name: Upload AI inputs (artifacts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-inputs
          path: |
            diff.txt
            merged-rules.txt
            hints.txt

      # 4. 呼叫 OpenAI（或你之後自己的 AI）
      - name: Call OpenAI for AI review
        if: ${{ steps.diff.outputs.diff_empty != 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY is not provided. Please add it as a secret in the caller repository or remove 'ai' from 'agents'." >&2
            exit 1
          fi

          # Truncate diff if larger than configured limit to keep request within token budget
          MAX_CHARS=${{ inputs.ai_max_diff_chars }}
          DIFF_PAYLOAD=$(cat diff.txt)
          DIFF_LEN=${#DIFF_PAYLOAD}
          if [ "$DIFF_LEN" -gt "$MAX_CHARS" ]; then
            TRUNCATED=$(head -c "$MAX_CHARS" diff.txt)
            NOTICE="\n\n[TRUNCATED to ${MAX_CHARS} chars from ${DIFF_LEN}]"
            JSON_DIFF_PAYLOAD=$(printf '%s' "$TRUNCATED$NOTICE" | jq -Rs .)
          else
            JSON_DIFF_PAYLOAD=${{ steps.diff.outputs.json_diff }}
          fi

          BODY=$(cat <<'EOF'
          {
            "model": "gpt-5-mini",
            "temperature": 0,
            "messages": [
              {
                "role": "system",
                "content": "你是本公司的後端程式碼 reviewer。請嚴格依照公司規範審查這次變更，並用繁體中文回覆。重要：僅以 JSON 回覆，且必須符合以下 schema：{\n  \"violations\": [\n    {\n      \"rule\": string,            // 觸犯的規則或分類\n      \"severity\": \"minor|major|critical\",\n      \"file\": string,            // 嘗試從 diff 推斷，未知填 \"unknown\"\n      \"line\": number|null,       // 嘗試從 diff 推斷，未知可為 null\n      \"snippet\": string,         // 涉及的片段（可節錄）\n      \"explanation\": string,     // 問題說明與風險\n      \"fix\": string              // 具體修正建議\n    }\n  ]\n}. 嚴禁輸出 Markdown 或多餘文字，僅輸出符合 schema 的 JSON。"
              },
              {
                "role": "system",
                "content": ${{ steps.rules.outputs.json_rules }}
              },
              {
                "role": "user",
                "content": "以下為針對 diff 產生的提示（僅供聚焦可能的問題點）："
              },
              {
                "role": "user",
                "content": ${{ steps.hints.outputs.json_hints }}
              },
              {
                "role": "user",
                "content": "以下是這次變更的 Git diff，請依照上述公司規範指出問題、風險與建議："
              },
              {
                "role": "user",
                "content": ${JSON_DIFF_PAYLOAD}
              }
            ],
            "max_tokens": 1000
          }
          EOF
          )
          
          # Capture HTTP status and body separately for better diagnostics
          HTTP_CODE=$(mktemp)
          RESP_BODY=$(mktemp)
          curl -s -w "%{http_code}" -o "$RESP_BODY" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" > "$HTTP_CODE"
          STATUS=$(cat "$HTTP_CODE")
          RESPONSE=$(cat "$RESP_BODY")

          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          if [ -z "$CONTENT" ] || [ "$STATUS" -ge 400 ]; then
            echo "[ai-review] No content returned from OpenAI. Printing raw response snippet for debugging." >&2
            SNIPPET=$(echo "$RESPONSE" | head -c 500)
            {
              echo "### AI Review · Result"
              echo "- HTTP status: ${STATUS}"
              echo "- Status: no content returned from provider"
              echo "<details><summary>Raw response (first 500 chars)</summary>"
              echo
              echo '```json'
              echo "$SNIPPET"
              echo
              echo '```'
              echo "</details>"
              echo
              echo "> 如果你看到空結果：請確認 OPENAI_API_KEY 是否有效、模型名稱是否可用、或稍後重試。"
            } >> "$GITHUB_STEP_SUMMARY"
            # 仍不中止流程，避免阻斷其他檢查
            exit 0
          else
            # 嘗試解析 JSON 結果
            if echo "$CONTENT" | jq -e . >/dev/null 2>&1; then
              echo "$CONTENT" > ai-result.json
              VIOLATION_COUNT=$(jq '.violations | length' ai-result.json 2>/dev/null || echo 0)
              CRIT_COUNT=$(jq '[.violations[] | select(.severity=="critical")] | length' ai-result.json 2>/dev/null || echo 0)
              MAJOR_COUNT=$(jq '[.violations[] | select(.severity=="major")] | length' ai-result.json 2>/dev/null || echo 0)
              MINOR_COUNT=$(jq '[.violations[] | select(.severity=="minor")] | length' ai-result.json 2>/dev/null || echo 0)

              {
                echo "### AI Review · Result"
                echo "- Total violations: ${VIOLATION_COUNT}"
                echo "- critical: ${CRIT_COUNT}, major: ${MAJOR_COUNT}, minor: ${MINOR_COUNT}"
                echo "<details><summary>Top violations (up to 10)</summary>"
                echo
                echo '```json'
                jq '{violations: (.violations[:10])}' ai-result.json
                echo '```'
                echo "</details>"
              } >> "$GITHUB_STEP_SUMMARY"

              # Optional fail policy
              FAIL_ON=${{ inputs.ai_fail_on_violation }}
              MIN_SEV=${{ inputs.ai_fail_min_severity }}
              if [ "$FAIL_ON" = "true" ]; then
                THRESHOLD=0
                case "$MIN_SEV" in
                  critical)
                    THRESHOLD=$CRIT_COUNT ;;
                  major)
                    THRESHOLD=$((CRIT_COUNT + MAJOR_COUNT)) ;;
                  minor)
                    THRESHOLD=$((CRIT_COUNT + MAJOR_COUNT + MINOR_COUNT)) ;;
                  *)
                    THRESHOLD=$((CRIT_COUNT + MAJOR_COUNT)) ;;
                esac
                if [ "$THRESHOLD" -gt 0 ]; then
                  echo "[ai-review] Failing due to violations (threshold=$MIN_SEV)." >&2
                  exit 2
                fi
              fi
            else
              echo "[ai-review] Model did not return valid JSON despite instruction. Showing raw content." >&2
              {
                echo "### AI Review · Result"
                echo "- Warning: non-JSON content returned"
                echo '<details><summary>Raw content</summary>'
                echo
                echo '```'
                echo "$CONTENT"
                echo '```'
                echo '</details>'
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
